import { assoc, head, isEmpty, map, pipe } from 'ramda';
import moment from 'moment';
import pubsub from '../config/bus';
import driver from '../database/neo4j';
import { FunctionalError } from '../config/errors';
import { MALWARE_ADDED_TOPIC } from '../config/conf';

export const findAll = (first, offset) => {
  const session = driver.session();
  const promise = session.run(
    'MATCH (malware:Malware) RETURN malware ORDER BY malware.id SKIP {skip} LIMIT {limit}',
    { skip: offset, limit: first }
  );
  return promise.then(data => {
    session.close();
    return map(record => record.get('malware').properties, data.records);
  });
};

export const findById = malwareId => {
  const session = driver.session();
  const promise = session.run(
    'MATCH (malware:Malware {id: {malwareId}}) RETURN malware',
    { malwareId }
  );
  return promise.then(data => {
    session.close();
    if (isEmpty(data.records))
      throw new FunctionalError({ message: 'Cant find this malware' });
    return head(data.records).get('malware').properties;
  });
};

export const addMalware = async malware => {
  const completeMalware = pipe(
    assoc('type', 'malware'),
    assoc('created_at', moment().toISOString()),
    assoc('revoked', false)
  )(malware);
  const session = driver.session();
  const promise = session.run(
    'CREATE (malware:Malware {malware}) RETURN malware',
    { malware: completeMalware }
  );
  return promise.then(data => {
    session.close();
    const malwareAdded = head(data.records).get('malware').properties;
    pubsub.publish(MALWARE_ADDED_TOPIC, { malwareAdded });
    return malwareAdded;
  });
};

export const deleteMalware = malwareId => {
  const session = driver.session();
  const promise = session.run(
    'MATCH (malware:Malware {id: {malwareId}}) DELETE malware RETURN malware',
    { malwareId }
  );

  return promise.then(data => {
    session.close();
    if (isEmpty(data.records)) {
      throw new FunctionalError({ message: "Malware doesn't exist" });
    } else {
      return malwareId;
    }
  });
};
